<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>æˆ‘çš„å…¨èƒ½æ—©é¤åº— - ç¶“ç‡Ÿå®‡å®™</title>
    <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        /* 1. åŸºç¤è¨­å®š */
        html, body { height: 100%; width: 100%; margin: 0; padding: 0; overflow: hidden; background-color: #2c3e50; font-family: 'Microsoft JhengHei', sans-serif; }
        .container { display: flex; flex-direction: column; height: 100vh; width: 100vw; background: #fff; border: 8px solid #e67e22; box-sizing: border-box; }
        .hidden { display: none !important; }

        /* 2. æ¨™é¡Œèˆ‡èˆå° */
        .header { flex: 0 0 50px; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; background: #e67e22; color: white; font-size: 20px; font-weight: bold; z-index: 100; }
        .stage { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 0; box-sizing: border-box; overflow: hidden; position: relative; }

        /* 3. æ“¬çœŸå ´æ™¯ä½ˆå±€ */
        #game-zone {
            background: url('https://img.freepik.com/free-photo/blurred-coffee-shop_1203-227.jpg') center/cover;
            position: relative;
        }

        .counter-desk {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 35%;
            background: url('https://img.freepik.com/free-photo/wooden-plank-textured-background-material_53876-33591.jpg') center/cover;
            border-top: 15px solid #5d4037;
            box-shadow: 0 -10px 50px rgba(0,0,0,0.5);
            z-index: 10; display: flex; flex-direction: column; align-items: center;
        }

        .char-img { 
            position: absolute; bottom: 30%; left: 50%; transform: translateX(-80%);
            height: 65%; object-fit: contain; 
            filter: drop-shadow(0 10px 20px rgba(0,0,0,0.3));
            transition: 0.3s; z-index: 5;
        }

        /* 4. ä»‹é¢å…ƒä»¶ */
        .stat-bar { 
            position: absolute; top: 10px; left: 2%; width: 96%; height: 60px; 
            background: rgba(255, 255, 255, 0.95); border: 3px solid #e67e22; border-radius: 50px; 
            display: flex; justify-content: space-around; align-items: center; 
            z-index: 20; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .bubble { 
            position: absolute; top: 100px; left: 5%; width: 50%; 
            background: white; border: 4px solid #333; border-radius: 30px; padding: 20px; 
            font-size: 20px; line-height: 1.5; box-shadow: 10px 10px 0px rgba(0,0,0,0.1); z-index: 15;
        }
        .bubble::after { content: ''; position: absolute; bottom: -20px; left: 100px; border-width: 20px 20px 0; border-style: solid; border-color: #333 transparent transparent transparent; }

        .option-zone { 
            position: absolute; bottom: 20px; right: 20px; width: 40%; height: 50%;
            display: flex; flex-direction: column; justify-content: flex-end; 
            z-index: 30; padding-bottom: 20px;
        }
        .option-btn { 
            width: 100%; padding: 15px; margin: 6px 0; 
            border: 3px solid #8e44ad; background: white; color: #2c3e50;
            border-radius: 15px; cursor: pointer; font-size: 20px; font-weight: bold; 
            transition: 0.2s; box-shadow: 0 5px #6c3483;
        }
        .option-btn:hover { transform: translateY(-3px); background: #f4ecf7; }
        .option-btn:active { transform: translateY(2px); box-shadow: 0 0 #6c3483; }

        #persistent-hint { 
            position: absolute; top: 320px; left: 5%; width: 50%;
            background: rgba(255, 243, 205, 0.95); color: #856404; border: 2px solid #ffeeba; 
            padding: 15px; border-radius: 15px; font-size: 18px; line-height: 1.4; display: none; z-index: 15;
        }

        /* 5. å‹•ç•«èˆ‡äº’å‹•è¦–çª— */
        .flying-coin {
            position: absolute; bottom: -100px; left: 50%; width: 80px; height: 80px;
            background: url('https://cdn-icons-png.flaticon.com/512/2460/2460475.png') center/contain no-repeat;
            filter: drop-shadow(0 5px 5px rgba(0,0,0,0.3)); z-index: 50;
            animation: payMoney 1s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }
        @keyframes payMoney {
            0% { transform: translateY(0) scale(1) rotate(0deg); opacity: 1; }
            80% { opacity: 1; }
            100% { transform: translateY(-400px) scale(0.6) rotate(360deg); opacity: 0; }
        }
        #paid-stamp {
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
            text-align: center; z-index: 60; pointer-events: none;
        }
        .stamp-anim { animation: stampIn 0.5s cubic-bezier(0.6, -0.28, 0.735, 0.045) forwards; }
        @keyframes stampIn { from { transform: translate(-50%, -50%) scale(3); opacity: 0; } to { transform: translate(-50%, -50%) scale(1); opacity: 1; } }

        .buy-btn { padding: 8px 20px; background: #e74c3c; color: white; border: none; border-radius: 20px; font-weight: bold; cursor: pointer; font-size: 16px; transition: 0.3s; box-shadow: 0 4px #c0392b; }
        .buy-btn:active { transform: translateY(4px); box-shadow: 0 0 #c0392b; }
        .buy-btn:disabled { background: #bdc3c7; color: #7f8c8d; box-shadow: none; cursor: not-allowed; opacity: 0.8; transform: none; }
        
        .feedback-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 100; }
        .feedback-box { width: 500px; background: white; border: 6px solid #e67e22; border-radius: 30px; padding: 30px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5); animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .info-board { width: 85%; max-width: 600px; background: #fef5e7; border: 6px double #e67e22; border-radius: 30px; padding: 30px; text-align: left; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        /* å¤§å»³ä½ˆå±€èˆ‡å¡ç‰‡ */
        #level-map { 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            padding: 20px; gap: 40px; 
        }
        
        .menu-section-title { 
            font-size: 24px; font-weight: bold; color: #d35400; margin-bottom: 15px; 
            display: flex; align-items: center; gap: 10px;
        }
        .menu-section-title::before, .menu-section-title::after {
            content: ""; display: block; width: 50px; height: 3px; background: #d35400; opacity: 0.5; border-radius: 2px;
        }

        .level-container { display: flex; gap: 30px; justify-content: center; flex-wrap: wrap; }
        .level-card { 
            width: 220px; height: 280px; background: white; 
            border: 4px solid #e67e22; border-radius: 20px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            cursor: pointer; transition: 0.3s; box-shadow: 0 8px 20px rgba(0,0,0,0.15); 
            position: relative; overflow: hidden; 
        }
        .level-card:hover { transform: translateY(-8px); box-shadow: 0 15px 30px rgba(0,0,0,0.2); }
        
        /* é–å®šå•†åº—æ¨£å¼ (æ·±å¤œæ˜Ÿç©ºä¸»é¡Œ) */
        .level-card.locked { 
            border: 4px solid #2c3e50; 
            background: linear-gradient(135deg, #1a252f 0%, #2c3e50 100%); 
            cursor: default; 
            box-shadow: inset 0 0 30px #000;
        }
        .level-card.locked:hover { transform: none; box-shadow: inset 0 0 30px #000; }
        
        /* é–å®šé®ç½© */
        .lock-overlay { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            color: #f1c40f; 
            text-shadow: 0 0 10px rgba(241, 196, 15, 0.5);
            z-index: 5;
        }
        
        /* è§£é–æŒ‰éˆ•èˆ‡æç¤º */
        .unlock-btn { 
            padding: 8px 16px; background: #f39c12; color: white; border: 2px solid #e67e22; 
            border-radius: 20px; font-weight: bold; cursor: pointer; margin-top: 15px; 
            font-size: 15px; animation: pulse 1.5s infinite; transition: 0.2s;
            box-shadow: 0 4px 10px rgba(243, 156, 18, 0.4);
        }
        .unlock-btn:hover { background: #e67e22; transform: scale(1.05); }
        
        .lock-msg { 
            color: #e74c3c; background: rgba(255, 255, 255, 0.95); padding: 5px 12px; border-radius: 15px; 
            font-weight: bold; font-size: 14px; margin-top: 10px; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        /* ç¦åˆ©ç¤¾å¡ç‰‡ */
        .welfare-card { 
            width: 470px; height: 140px; 
            background: linear-gradient(to right, #ffffff, #eaf2f8); 
            border: 4px solid #3498db; border-radius: 20px; 
            display: flex; align-items: center; justify-content: space-around; 
            cursor: pointer; transition: 0.3s; box-shadow: 0 8px 20px rgba(52, 152, 219, 0.2);
        }
        .welfare-card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(52, 152, 219, 0.4); }

        .video-container { aspect-ratio: 16 / 9; width: min(95vw, calc((100vh - 300px) * 1.777)); border: 5px solid #f1c40f; border-radius: 15px; background: #000; flex-shrink: 0; margin: 0 auto; }
        iframe { width: 100%; height: 100%; border: none; overflow: hidden; }
        .btn { padding: 12px 50px; background: #27ae60; color: white; border: none; border-radius: 50px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 15px; }
        #timer-msg { color: #f1c40f; font-size: 18px; font-weight: bold; margin-top: 15px; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; transform: scale(1); } 50% { opacity: 0.9; transform: scale(1.05); } 100% { opacity: 1; transform: scale(1); } }

        /* ç›²ç›’éŠæˆ² */
        #guess-box-game { background: #2c3e50; justify-content: center; align-items: center; flex-direction: column; }
        .chest-container { display: flex; gap: 50px; margin: 30px 0; }
        .chest { width: 180px; height: 180px; background: url('https://cdn-icons-png.flaticon.com/512/4230/4230569.png') center/contain no-repeat; cursor: pointer; transition: 0.2s; position: relative; }
        .chest:hover { transform: scale(1.1) rotate(5deg); }
        .chest.disabled { filter: grayscale(100%); opacity: 0.5; cursor: not-allowed; transform: none; }
        .chest.open-empty { background-image: url('https://cdn-icons-png.flaticon.com/512/4230/4230563.png'); filter: grayscale(100%); opacity: 0.8; }
        .chest.open-money { background-image: url('https://cdn-icons-png.flaticon.com/512/4230/4230606.png'); filter: none; opacity: 1; transform: scale(1.1); }
        .asset-tag { background: #f1c40f; color: #333; padding: 10px 20px; border-radius: 50px; font-weight: bold; font-size: 24px; border: 3px solid #e67e22; }
        .chest-result { position: absolute; bottom: -40px; left: 50%; transform: translateX(-50%); color: white; font-weight: bold; font-size: 20px; white-space: nowrap; opacity: 0; transition: 0.5s; }
        .chest.revealed .chest-result { opacity: 1; bottom: -30px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div>ğŸ³ æˆ‘çš„å…¨èƒ½æ—©é¤åº—</div>
        <div id="total-assets-display" style="background: rgba(255,255,255,0.2); padding: 5px 15px; border-radius: 20px;">
            ğŸ¦ éŠ€è¡Œç¸½è³‡ç”¢: $0
        </div>
    </div>

    <div id="level-map" class="stage" style="background: #f1c40f;">
        
        <div class="menu-section-title">ğŸ™ï¸ å•†åº—è¡—ç¶“ç‡Ÿ</div>
        <div class="level-container">
            <div class="level-card" onclick="showLevelStory('å…ƒæ°£æ—©é¤åº—', 'äºŒå…ƒä¸€æ¬¡æ–¹ç¨‹å¼', 'å­¸å€çš„å®¢äººç¿’æ…£åŒæ™‚è³¼è²·åŒ…å­èˆ‡è±†æ¼¿ï¼Œå°å¿ƒè¨ˆç®—åˆ¥æ‰¾éŒ¯éŒ¢ï¼')">
                <div style="font-size:60px;">ğŸ³</div>
                <h3 style="font-size:22px; margin:10px 0;">å…ƒæ°£æ—©é¤åº—</h3>
                <p>ä¸»é¡Œï¼šäºŒå…ƒä¸€æ¬¡</p>
                <div style="color:#27ae60; font-weight:bold;">â— ç‡Ÿæ¥­ä¸­</div>
            </div>
            
            <div class="level-card locked" id="shop-2-card">
                <div style="font-size:60px; filter: drop-shadow(0 0 5px #f1c40f);">ğŸœ</div>
                <h3 style="font-size:22px; margin:10px 0; color: #ecf0f1;">æ·±å¤œé£Ÿå ‚</h3>
                <p style="color: #bdc3c7;">ä¸»é¡Œï¼šæ¯”ä¾‹å¼</p>
                
                <div class="lock-overlay" id="shop-2-lock">
                    <div style="font-size:40px;">ğŸ”’</div>
                    <div style="font-size:18px; margin-top:5px; color:#fff; font-weight:bold;">æœªè§£é–</div>
                    
                    <button id="shop-2-btn" class="unlock-btn hidden" onclick="tryUnlockShop(event)">
                        ğŸ”“ èŠ±è²» $300 è§£é–
                    </button>
                    
                    <div id="shop-2-msg" class="lock-msg">
                        ğŸ”’ è³‡é‡‘æœªé”æ¨™ (éœ€ $300)
                    </div>
                </div>
                <div class="hidden" id="shop-2-open" style="color:#27ae60; font-weight:bold; margin-top:10px;">â— ç‡Ÿæ¥­ä¸­</div>
            </div>
        </div>

        <br><br>

        <div class="menu-section-title" style="color:#2980b9;">ğŸ å“¡å·¥ä¼‘é–’å€</div>
        <div class="welfare-card" onclick="startGuessBoxGame()">
            <div style="font-size:70px;">ğŸ</div>
            <div style="text-align: left;">
                <h3 style="margin:10px 0; color:#3498db; font-size:24px;">ç‡Ÿæ¥­ç¦åˆ©ç¤¾</h3>
                <p style="margin:0; color:#555; font-size:16px;">è³ºéŒ¢è¾›è‹¦äº†ï¼ä¾†æŠ½å€‹ç›²ç›’è©¦è©¦æ‰‹æ°£å§ï¼</p>
            </div>
            <div style="font-size:30px; color:#e74c3c;">â”</div>
        </div>
    </div>

    <div id="level-info" class="stage hidden" style="background: rgba(0,0,0,0.85);">
        <div class="info-board">
            <h2 id="info-title" style="text-align: center; color: #e67e22;"></h2>
            <div style="margin: 20px 0; font-size: 18px; line-height: 1.6; color: #5d4037;">
                <p id="info-story"></p>
                <p><strong>æœ¬é—œä»»å‹™ï¼š</strong>é‹ç”¨æ–¹ç¨‹å¼ç²¾æº–çµå¸³ï¼Œç´¯ç©ç‡Ÿæ¥­é¡å­˜å…¥éŠ€è¡Œï¼</p>
                <p style="color:#c0392b; font-weight:bold;">âš ï¸ æ³¨æ„ï¼šå¦‚æœå€’é–‰ï¼Œå°‡å€’æ‰£éŠ€è¡Œè³‡ç”¢ $300 ä½œç‚ºé£Ÿæè³ å„Ÿï¼</p>
            </div>
            <div style="text-align:center;">
                <button class="btn" onclick="startStory()">æ¥å—æŒ‘æˆ°</button>
                <button class="btn" style="background:#7f8c8d;" onclick="showStage('level-map')">ç¨å¾Œå†è©¦</button>
            </div>
        </div>
    </div>

    <div id="intro-phase" class="stage hidden" style="background: url('https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?auto=format&fit=crop&q=80&w=1000') center/cover;">
        <div style="background:rgba(255,255,255,0.95); border:4px solid #e67e22; border-radius:20px; padding:25px; width:80%; cursor:pointer;" onclick="nextDialogue()">
            <div style="font-weight:bold; color:#e67e22; font-size:22px;" id="speaker-name">å°å¸«</div>
            <div id="dialogue-content" style="font-size: 20px; margin-top:10px;">...</div>
            <div style="text-align: right; font-size: 14px; color: #aaa;">é»æ“Šç¹¼çºŒ â–¼</div>
        </div>
    </div>

    <div id="learning-phase" class="stage hidden" style="background:#34495e;">
        <div class="video-container">
            <iframe id="h5p-container" src="https://kxc24.h5p.com/content/1292776058263996339/embed" allowfullscreen></iframe>
        </div>
        <div id="timer-msg">ğŸ”’ åŸ¹è¨“é€²è¡Œä¸­...</div>
        <button id="start-game-btn" class="btn" onclick="startGame()" style="display:none;">ğŸ“ åŸ¹è¨“å®Œæˆï¼Œæ­£å¼é–‹åº—ï¼</button>
        <button class="btn" style="background: #95a5a6; font-size: 16px; padding: 10px 30px;" onclick="returnToMap()">ğŸ™ï¸ è¿”å›å¤§å»³</button>
    </div>

    <div id="game-zone" class="stage hidden">
        <div class="stat-bar">
            <div id="customer-count" style="font-size:20px; font-weight:bold; color:#2c3e50;">ğŸ‘¤ ç¬¬ 1 / 10 ä½é¡§å®¢</div>
            <div id="score-display" style="font-size:20px; font-weight:bold; color:#d35400;">ğŸ’° æœ¬æ¬¡ç‡Ÿæ”¶: $0</div>
            <button id="buy-heart-btn" onclick="buyHeart()" class="buy-btn" disabled>ğŸ”’ ç­”å°5é¡Œå¾Œè§£é–</button>
            <div id="hp-display" style="font-size:20px; font-weight:bold; color:#d35400;">â¤ï¸ æ»¿æ„åº¦: â¤ï¸â¤ï¸â¤ï¸</div>
        </div>

        <img id="char-img" class="char-img" src="https://cdn-icons-png.flaticon.com/512/4140/4140048.png" alt="Customer">

        <div class="bubble">
            <p id="q-text" style="margin: 0;">é¡Œç›®è¼‰å…¥ä¸­...</p>
        </div>

        <div id="persistent-hint"></div>

        <div class="counter-desk">
            <div id="paid-stamp" class="hidden">
                <img src="https://cdn-icons-png.flaticon.com/512/5610/5610944.png" alt="Paid" width="120">
                <div style="color: #27ae60; font-weight:bold; font-size: 24px; text-shadow: 2px 2px 0 #fff;">æ”¯ä»˜æˆåŠŸï¼<br>æ»¿æ„åº¦ +1 â¤ï¸</div>
            </div>
        </div>

        <div class="option-zone" id="options-container"></div>
        <div id="money-container"></div>
    </div>

    <div id="feedback-modal" class="feedback-overlay hidden">
        <div class="feedback-box">
            <h2 id="fb-title" style="font-size: 36px; margin: 10px 0;">ğŸ‰ å¤ªæ£’äº†ï¼</h2>
            <p id="fb-msg" style="font-size: 22px; color: #555;">å®¢äººå¾ˆæ»¿æ„ï¼Œç‡Ÿæ”¶ +$200</p>
            <div id="fb-hint" style="background:#fff3cd; padding:15px; border-radius:10px; margin: 15px 0; text-align: left; display: none;"></div>
            <button id="fb-btn" class="btn" onclick="closeFeedback()">ç¹¼çºŒä¸‹ä¸€ä½å®¢äºº â–¶</button>
        </div>
    </div>

    <div id="guess-box-game" class="stage hidden">
        <h2 style="color: white; margin-bottom: 20px;">ğŸ“¦ å¹¸é‹ç›²ç›’ (å…¥å ´è²» $500)</h2>
        <div class="asset-tag" id="game-asset-display">ğŸ¦ è³‡ç”¢: $0</div>
        
        <div class="chest-container" id="chest-container"></div>
        
        <button id="replay-btn" class="btn hidden" style="background:#f1c40f; color:#333;" onclick="startGuessBoxGame()">ğŸ”„ èŠ± $500 å†æŠ½ä¸€æ¬¡</button>

        <div style="margin-top: 30px;">
            <button class="btn" style="background:#7f8c8d;" onclick="returnToMap()">ğŸ™ï¸ è¿”å›å¤§å»³</button>
        </div>
    </div>

    <div id="message-modal" class="feedback-overlay hidden">
        <div class="feedback-box" style="border-color: #3498db; width: 450px;">
            <h2 id="msg-title" style="color: #3498db; font-size: 32px;">æ¨™é¡Œ</h2>
            <p id="msg-content" style="font-size: 20px; color: #555;">å…§å®¹</p>
            <div style="margin-top: 25px; display: flex; justify-content: center; gap: 15px;">
                <button id="msg-ok-btn" class="btn" style="background: #3498db; margin:0;">ç¢ºå®š</button>
                <button id="msg-cancel-btn" class="btn" style="background: #95a5a6; margin:0; display:none;">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <div id="fail-menu" class="stage hidden" style="background: rgba(44, 62, 80, 0.95);">
        <div style="background:white; padding:40px; border-radius:25px; text-align:center; max-width: 500px;">
            <h2 id="end-title" style="color: #c0392b; font-size: 32px;">ğŸ’” ç‡Ÿæ¥­çµæŸ</h2>
            <p style="font-size: 20px;">æœ¬æ¬¡ç‡Ÿæ”¶ï¼š<span id="end-score" style="color: #27ae60; font-weight:bold;">$0</span></p>
            <p id="end-asset-msg" style="color: #7f8c8d; font-size: 18px; margin-top:10px;">(å·²å­˜å…¥æ‚¨çš„éŠ€è¡Œç¸½è³‡ç”¢)</p>
            
            <div id="win-buttons" class="hidden">
                <button class="btn" style="background:#3498db; color:white;" onclick="startGuessBoxGame()">ğŸ å‰å¾€ç¦åˆ©ç¤¾èŠ±éŒ¢ï¼</button>
            </div>

            <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 20px;">
                <button class="btn" style="background:#e67e22;" onclick="retryGame()">ğŸ”„ é‡æ–°é–‹åº—</button>
                <button class="btn" style="background:#7f8c8d;" onclick="returnToMap()">ğŸ™ï¸ è¿”å›å¤§å»³</button>
            </div>
        </div>
    </div>
</div>

<script>
    const charImages = [
        "https://cdn-icons-png.flaticon.com/512/4140/4140048.png", 
        "https://cdn-icons-png.flaticon.com/512/4140/4140047.png", 
        "https://cdn-icons-png.flaticon.com/512/6997/6997662.png", 
        "https://cdn-icons-png.flaticon.com/512/4140/4140037.png"
    ];

    const quizData = [
        { q: "æˆ‘è¦è²·7å€‹è‚‰åŒ…å’Œ2æ¯è±†æ¼¿å…±129å…ƒï¼Œå¦ä¸€æ¬¡è²·3å€‹è‚‰åŒ…å’Œ4æ¯è±†æ¼¿æ˜¯93å…ƒã€‚è«‹å•è‚‰åŒ…ä¸€å€‹å¤šå°‘ï¼Ÿ", options: ["$12", "$15", "$18", "$20"], a: "$15", hint: "è¨­è‚‰åŒ…xã€è±†æ¼¿yã€‚æŠŠè±†æ¼¿æ•¸é‡è®Šä¸€æ¨£(æ‰¾2å’Œ4çš„å…¬å€æ•¸)å†ç›¸æ¸›å°±èƒ½æ¶ˆæ‰è±†æ¼¿å›‰ï¼" },
        { q: "æˆ‘é»äº† $$3x - 4(x - 2y) + 5$$ é€™éº¼å¤šï¼ŒåŒ–ç°¡å¾Œ x çš„ä¿‚æ•¸æ˜¯å¤šå°‘ï¼Ÿ", options: ["1", "3", "-1", "-4"], a: "-1", hint: "æ³¨æ„æ‹¬è™Ÿå‰çš„è² è™Ÿï¼-4 ä¹˜é€²å»æ™‚ï¼Œè£¡é¢çš„ -2y è¦è®Šè™Ÿå–”ã€‚" },
        { q: "æ•¸é‡æ»¿è¶³ $$7x + 3y = 27$$ã€‚å¦‚æœ y æ˜¯ 2ï¼Œé‚£ x æ˜¯å¤šå°‘ï¼Ÿ", options: ["3", "4", "5", "6"], a: "3", hint: "æŠŠ y=2 ä»£é€²å»ï¼š7x + 6 = 27ï¼Œæ¥è‘—è§£ x å°±å¯ä»¥äº†ã€‚" },
        { q: "å…©ä»½é€£çºŒæ­£æ•´æ•¸é¤é»ç·¨è™Ÿç›¸åŠ æ˜¯ 21ï¼Œç·¨è™Ÿè¼ƒå¤§çš„æ˜¯å¤šå°‘ï¼Ÿ", options: ["10", "11", "12", "13"], a: "11", hint: "è¨­å°è™Ÿxï¼Œå¤§è™Ÿx+1ã€‚x + (x+1) = 21ï¼Œç®—å‡ºxå¾Œè¨˜å¾—+1æ‰æ˜¯å¤§è™Ÿå–”ã€‚" },
        { q: "2ä»½Aé¤èˆ‡3ä»½Bé¤å…±220å…ƒï¼ŒAæ¯”Bè²´10å…ƒï¼Œé‚£Bé¤å¤šå°‘å…ƒï¼Ÿ", options: ["$35", "$40", "$45", "$50"], a: "$40", hint: "è¨­Bç‚ºxï¼Œå‰‡Aæ˜¯(x+10)ã€‚2(x+10) + 3x = 220ï¼Œè§£å‡ºxå³å¯ã€‚" },
        { q: "åŒ–ç°¡ $$2(x + 3y) - 3(2x - y)$$ å¾Œï¼Œy é …ä¿‚æ•¸æ˜¯å¤šå°‘ï¼Ÿ", options: ["3", "6", "9", "-3"], a: "9", hint: "æ‹†æ‹¬è™Ÿï¼š2x+6y å’Œ -6x+3yã€‚æŠŠyåˆèµ·ä¾†ï¼š6y+3y=9yã€‚" },
        { q: "è‹¥ (1, -1) æ˜¯ $$ax + by = 5$$ çš„è§£ï¼Œä¸” a+b=1ï¼Œé‚£ a æ˜¯å¤šå°‘ï¼Ÿ", options: ["2", "3", "4", "5"], a: "3", hint: "ä»£å…¥å¾— a-b=5ï¼Œè·Ÿ a+b=1 è§£è¯ç«‹ã€‚å…©å¼ç›¸åŠ ï¼š2a=6ï¼Œa=3ã€‚" },
        { q: "æˆ‘æœ‰xå¼µç™¾å…ƒéˆ”å’Œyå€‹åå…ƒå¹£å…±540å…ƒã€‚è‹¥x+y=18ï¼Œå‰‡xæ˜¯å¤šå°‘ï¼Ÿ", options: ["4", "5", "6", "7"], a: "4", hint: "éŒ¢ï¼š100x+10y=540ã€‚é‡ï¼šx+y=18ã€‚æŠŠç¬¬äºŒå¼x10ç›¸æ¸›ã€‚" },
        { q: "çˆ¶xæ­²å­yæ­²ã€‚äº”å¹´å‰çˆ¶æ˜¯å­çš„3å€ï¼Œæ­£ç¢ºå¼å­æ˜¯ï¼Ÿ", options: ["x-5 = 3(y-5)", "x = 3y", "x+5 = 3(y+5)", "x-5 = 3y-5"], a: "x-5 = 3(y-5)", hint: "äº”å¹´å‰å…©äººéƒ½è¦æ¸›5æ­²ï¼Œè¨˜å¾—è¦æŠŠ(y-5)æ‹¬è™Ÿèµ·ä¾†ä¹˜3å€ã€‚" },
        { q: "å¤§æ•¸å°æ•¸å·®8ï¼Œå¤§æ•¸æ˜¯å°æ•¸çš„2å€å°‘2ï¼Œæ±‚å¤§æ•¸ï¼Ÿ", options: ["14", "16", "18", "20"], a: "18", hint: "è¨­å°æ•¸xï¼Œå¤§æ•¸x+8ã€‚x+8 = 2x - 2ï¼Œè§£å‡ºxå†åŠ 8ã€‚" }
    ];

    let score = 0, hp = 3, currentQ = 0, shuffledQuiz = [];
    let correctCount = 0; 
    let totalAssets = 0;  
    const HEART_COST = 400; 
    const CHEST_COST = 500; 
    const SHOP_UNLOCK_COST = 300; // ğŸŒŸ é™ä½è§£é–è²»ç”¨ç‚º 300
    const FAIL_PENALTY = 300; 
    let unlockTimer = null;
    let lastRoundCorrect = false; 
    
    let selectedChestIndex = -1;
    let isGameLocked = false; 
    let isShop2Unlocked = false; 

    // ğŸŒŸ åˆå§‹åŒ–ï¼šè¡—æ©Ÿæ¨¡å¼ï¼Œæ¯æ¬¡é‡æ•´éƒ½æ­¸é›¶
    window.onload = function() {
        totalAssets = 0; 
        isShop2Unlocked = false; 
        updateTotalAssetsDisplay();
        updateShopUI(); 
        updateShopLockState(); 
    };

    function showStage(stageId) {
        document.querySelectorAll('.stage').forEach(s => s.classList.add('hidden'));
        document.getElementById(stageId).classList.remove('hidden');
        if(stageId === 'mini-game-menu' || stageId === 'guess-box-game') {
            updateTotalAssetsDisplay();
        }
        if(stageId === 'level-map') {
            updateShopLockState();
        }
    }

    function showLevelStory(title, topic, story) {
        document.getElementById('info-title').innerText = `ğŸ“œ é—œå¡ï¼š${title}`;
        document.getElementById('info-story').innerHTML = `${story}<br><br><strong>âš ï¸ å¤±æ•—æ‡²ç½°ï¼š</strong>è‹¥ç¶“ç‡Ÿå¤±æ•—ï¼Œå°‡å€’æ‰£è³‡ç”¢ <b>$${FAIL_PENALTY}</b>ï¼`;
        showStage('level-info');
    }

    function showMessage(title, content, isConfirm = false, onConfirm = null) {
        const modal = document.getElementById('message-modal');
        const mTitle = document.getElementById('msg-title');
        const mContent = document.getElementById('msg-content');
        const btnOk = document.getElementById('msg-ok-btn');
        const btnCancel = document.getElementById('msg-cancel-btn');

        mTitle.innerText = title;
        mContent.innerHTML = content;
        modal.classList.remove('hidden');

        btnOk.onclick = null;
        btnCancel.onclick = null;
        btnCancel.style.display = isConfirm ? 'inline-block' : 'none';

        btnOk.onclick = () => {
            modal.classList.add('hidden');
            if(onConfirm) onConfirm();
        };
        
        if(isConfirm) {
            btnCancel.onclick = () => {
                modal.classList.add('hidden');
            };
        }
    }

    function updateShopLockState() {
        if(isShop2Unlocked) return; 

        const btn = document.getElementById('shop-2-btn');
        const msg = document.getElementById('shop-2-msg');

        if(totalAssets >= SHOP_UNLOCK_COST) {
            btn.classList.remove('hidden'); 
            msg.classList.add('hidden');    
        } else {
            btn.classList.add('hidden');    
            msg.classList.remove('hidden'); 
        }
    }

    function tryUnlockShop(event) {
        event.stopPropagation(); 
        
        if(isShop2Unlocked) return;

        if (totalAssets < SHOP_UNLOCK_COST) {
            showMessage("ğŸ’¸ è³‡é‡‘ä¸è¶³", `è§£é–æ–°åº—é¢éœ€è¦ <b>$${SHOP_UNLOCK_COST}</b><br>æ‚¨ç›®å‰åªæœ‰ $${totalAssets}ã€‚`);
            return;
        }

        showMessage("ğŸ”’ è§£é–æ–°åº—é¢", `ç¢ºå®šèŠ±è²» <b>$${SHOP_UNLOCK_COST}</b><br>è§£é–ã€Œæ·±å¤œé£Ÿå ‚ã€å—ï¼Ÿ`, true, () => {
            totalAssets -= SHOP_UNLOCK_COST;
            isShop2Unlocked = true;
            updateTotalAssetsDisplay();
            updateShopUI();
            setTimeout(() => showMessage("ğŸ‰ è§£é–æˆåŠŸ", "æ‚¨å·²æ“´å±•ç‰ˆåœ–ï¼<br>ç¾åœ¨å¯ä»¥ç¶“ç‡Ÿã€Œæ·±å¤œé£Ÿå ‚ã€äº†ï¼"), 500);
        });
    }

    function updateShopUI() {
        if(isShop2Unlocked) {
            const card = document.getElementById('shop-2-card');
            const lock = document.getElementById('shop-2-lock');
            const open = document.getElementById('shop-2-open');
            card.classList.remove('locked');
            // è§£é–å¾Œæ¢å¾©æ­£å¸¸å¡ç‰‡æ¨£å¼
            card.style.background = "white";
            card.style.border = "4px solid #e67e22";
            card.querySelector('h3').style.color = "black";
            card.querySelector('p').style.color = "black";
            card.querySelector('div[style*="font-size:60px"]').style.filter = "none";
            
            card.onclick = () => showMessage("ğŸš§ æ–½å·¥ä¸­", "ç¬¬äºŒé—œå…§å®¹è£½ä½œä¸­ï¼Œæ•¬è«‹æœŸå¾…ï¼"); 
            lock.classList.add('hidden');
            open.classList.remove('hidden');
        }
    }

    function startStory() {
        showStage('intro-phase'); nextDialogue();
    }

    let dialIdx = 0;
    function nextDialogue() {
        const stories = ["é€™è£¡çš„å®¢äººå¾ˆæŒ‘å‰”ï¼Œç®—éŒ¯éŒ¢æœƒå€’é–‰å–”ï¼", "æº–å‚™å¥½äº†å—ï¼Ÿå…ˆé€²è¡Œè·å‰åŸ¹è¨“å§ã€‚"];
        if (dialIdx < stories.length) {
            document.getElementById('dialogue-content').innerText = stories[dialIdx];
            dialIdx++;
        } else {
            showStage('learning-phase');
            startUnlockTimer(112); 
        }
    }

    function startUnlockTimer(seconds) {
        if (unlockTimer) clearInterval(unlockTimer);
        let remaining = seconds;
        const btn = document.getElementById('start-game-btn');
        const msg = document.getElementById('timer-msg');
        btn.style.display = 'none'; msg.style.display = 'block';

        unlockTimer = setInterval(() => {
            remaining--;
            let m = Math.floor(remaining / 60);
            let s = remaining % 60;
            msg.innerText = `ğŸ”’ åŸ¹è¨“é€²è¡Œä¸­... (${m}:${s < 10 ? "0"+s : s} å¾Œè§£é–)`;
            if (remaining <= 0) {
                clearInterval(unlockTimer);
                msg.style.display = 'none';
                btn.style.display = 'block';
            }
        }, 1000);
    }

    function returnToMap() {
        document.getElementById('h5p-container').src = document.getElementById('h5p-container').src; 
        if (unlockTimer) clearInterval(unlockTimer);
        showStage('level-map');
    }

    function startGame() { 
        document.getElementById('h5p-container').src = document.getElementById('h5p-container').src; 
        retryGame(); 
    }

    function retryGame() {
        showStage('game-zone');
        shuffledQuiz = [...quizData].sort(() => Math.random() - 0.5);
        currentQ = 0; hp = 3; score = 0; correctCount = 0;
        updateStats(); renderQuestion();
    }

    function renderQuestion() {
        if (currentQ >= shuffledQuiz.length) { endGame(true); return; }
        
        const q = shuffledQuiz[currentQ];
        document.getElementById('q-text').innerHTML = q.q;
        document.getElementById('persistent-hint').style.display = 'none';

        document.getElementById('customer-count').innerText = `ğŸ‘¤ ç¬¬ ${currentQ + 1} / ${quizData.length} ä½é¡§å®¢`;

        if (document.getElementById('char-img').dataset.qid !== String(currentQ)) {
             const randomImg = charImages[Math.floor(Math.random() * charImages.length)];
             document.getElementById('char-img').src = randomImg;
             document.getElementById('char-img').dataset.qid = String(currentQ);
        }

        const container = document.getElementById('options-container');
        container.innerHTML = ''; 
        
        q.options.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'option-btn';
            btn.innerText = opt;
            btn.onclick = () => checkAnswer(opt);
            container.appendChild(btn);
        });
        if (window.MathJax) MathJax.typesetPromise();
    }

    function checkAnswer(ans) {
        const q = shuffledQuiz[currentQ];
        if (ans === q.a) {
            score += 200; 
            correctCount++; 
            lastRoundCorrect = true; 
            showFeedback(true, q);
        } else {
            hp--; 
            lastRoundCorrect = false; 
            showFeedback(false, q);
        }
    }

    function showFeedback(isCorrect, q) {
        const modal = document.getElementById('feedback-modal');
        const title = document.getElementById('fb-title');
        const msg = document.getElementById('fb-msg');
        const hint = document.getElementById('fb-hint');
        const btn = document.getElementById('fb-btn');

        modal.classList.remove('hidden');
        
        if (isCorrect) {
            title.innerText = "ğŸ‰ ç­”å°äº†ï¼";
            title.style.color = "#27ae60";
            msg.innerText = "å®¢äººå¾ˆæ»¿æ„ï¼Œæœ¬æ¬¡ç‡Ÿæ”¶ +$200";
            hint.style.display = 'none';
            btn.innerText = "ç¹¼çºŒä¸‹ä¸€ä½å®¢äºº â–¶";
            btn.style.background = "#27ae60";
        } else {
            title.innerText = "ğŸ˜± ç®—éŒ¯äº†...";
            title.style.color = "#c0392b";
            msg.innerText = "å®¢äººå¾ˆç”Ÿæ°£ï¼Œæ»¿æ„åº¦ -1";
            hint.style.display = 'block';
            hint.innerHTML = `ğŸ’¡ <b>å°å¸«æç¤ºï¼š</b>${q.hint}`;
            btn.innerText = "ğŸ”™ äº†è§£ï¼Œè¿”å›é‡è©¦";
            btn.style.background = "#e67e22";
        }
        updateStats();
    }

    function closeFeedback() {
        document.getElementById('feedback-modal').classList.add('hidden');
        
        if (hp <= 0) {
            endGame(false);
            return;
        }

        if (lastRoundCorrect) {
            currentQ++;
            renderQuestion();
        } else {
            const pHint = document.getElementById('persistent-hint');
            pHint.style.display = 'block';
            pHint.innerHTML = `ğŸ’¡ <b>æç¤ºï¼š</b>${shuffledQuiz[currentQ].hint}`;
        }
    }

    function playCashierAnimation() {
        const moneyContainer = document.getElementById('money-container');
        const stamp = document.getElementById('paid-stamp');
        stamp.classList.add('hidden');
        stamp.classList.remove('stamp-anim');
        moneyContainer.innerHTML = '';

        for (let i = 0; i < 3; i++) {
            const coin = document.createElement('div');
            coin.className = 'flying-coin';
            coin.style.animationDelay = `${i * 0.2}s`;
            coin.style.left = `${40 + Math.random() * 20}%`;
            moneyContainer.appendChild(coin);
        }

        setTimeout(() => {
            stamp.classList.remove('hidden');
            stamp.classList.add('stamp-anim');
        }, 1200);

        setTimeout(() => {
            stamp.classList.add('hidden');
            moneyContainer.innerHTML = '';
        }, 3200);
    }

    function buyHeart() {
        if (score >= HEART_COST && hp < 3) {
            score -= HEART_COST;
            hp++;
            updateStats();
            playCashierAnimation();
        }
    }

    function updateStats() {
        document.getElementById('score-display').innerText = `ğŸ’° æœ¬æ¬¡ç‡Ÿæ”¶: $${score}`;
        let hearts = ""; for(let i=0; i<3; i++) hearts += (i < hp) ? "â¤ï¸" : "ğŸ–¤";
        document.getElementById('hp-display').innerText = `æ»¿æ„åº¦: ${hearts}`;

        const btn = document.getElementById('buy-heart-btn');
        if (correctCount < 5) {
            btn.disabled = true;
            btn.innerText = `ğŸ”’ å†ç­”å° ${5 - correctCount} é¡Œè§£é–`;
            btn.style.background = "#95a5a6";
        } else if (score < HEART_COST || hp >= 3) {
            btn.disabled = true;
            btn.innerText = (hp >= 3) ? "â¤ï¸ æ»¿æ„åº¦å·²æ»¿" : `ğŸ’¸ è³‡é‡‘ä¸è¶³ ($${HEART_COST})`;
            btn.style.background = "#95a5a6";
        } else {
            btn.disabled = false;
            btn.innerText = `â¤ï¸ è³¼è²·å¥½è©• ($${HEART_COST})`;
            btn.style.background = "#e74c3c";
        }
    }

    function endGame(isWin) {
        showStage('fail-menu');
        const title = document.getElementById('end-title');
        const assetMsg = document.getElementById('end-asset-msg');
        const winBtns = document.getElementById('win-buttons');
        
        if (isWin) {
            title.innerText = "ğŸ‰ å®Œç¾æ‰“çƒŠï¼";
            title.style.color = "#27ae60";
            assetMsg.innerText = "(å·²å­˜å…¥æ‚¨çš„éŠ€è¡Œç¸½è³‡ç”¢)";
            winBtns.classList.remove('hidden'); 
            
            totalAssets += score;
        } else {
            title.innerText = "ğŸ’” æš«åœç‡Ÿæ¥­";
            title.style.color = "#c0392b";
            if(totalAssets > 0) {
                totalAssets -= FAIL_PENALTY;
                if(totalAssets < 0) totalAssets = 0;
                assetMsg.innerHTML = `(æŒ‘æˆ°å¤±æ•—ï¼Œè³‡ç”¢å€’æ‰£ <b style='color:#e74c3c;'>-$${FAIL_PENALTY}</b> ğŸ˜±)`;
            } else {
                assetMsg.innerText = "(æŒ‘æˆ°å¤±æ•—ï¼Œè³‡ç”¢æ­¸é›¶ ğŸ’¸)";
            }
            winBtns.classList.add('hidden');
        }
        
        // ğŸŒŸ æ›´æ–°è³‡ç”¢ä½†ä¸å­˜æª” (è¡—æ©Ÿæ¨¡å¼)
        updateTotalAssetsDisplay();
        document.getElementById('end-score').innerText = `$${score}`;
    }

    function updateTotalAssetsDisplay() {
        const text = `ğŸ¦ éŠ€è¡Œç¸½è³‡ç”¢: $${totalAssets}`;
        document.getElementById('total-assets-display').innerText = text;
        document.getElementById('game-asset-display').innerText = text;
        updateShopLockState();
    }

    function startGuessBoxGame() {
        showStage('guess-box-game');
        document.getElementById('replay-btn').classList.add('hidden');
        isGameLocked = false;
        selectedChestIndex = -1;

        const container = document.getElementById('chest-container');
        container.innerHTML = '';

        for(let i=0; i<3; i++) {
            const chest = document.createElement('div');
            chest.className = 'chest';
            chest.dataset.index = i;
            const resultText = document.createElement('div');
            resultText.className = 'chest-result';
            chest.appendChild(resultText);
            chest.onclick = () => openChestConfirm(i);
            container.appendChild(chest);
        }
    }

    function openChestConfirm(index) {
        if(isGameLocked) return;
        if (totalAssets < CHEST_COST) {
            showMessage("ğŸ’¸ é¤˜é¡ä¸è¶³", "éŒ¢ä¸å¤ ç©é€™å€‹å•¦ï¼<br>å¿«å›å»æ‰“å·¥è³ºéŒ¢ï¼");
            return;
        }
        selectedChestIndex = index;
        showMessage("ğŸ’³ ç¢ºèªäº¤æ˜“", `ç¢ºå®šèŠ±è²» <b style="color:#e74c3c;">$500</b><br>é–‹å•Ÿé€™å€‹ç›²ç›’å—ï¼Ÿ`, true, confirmPurchase);
    }

    function confirmPurchase() {
        totalAssets -= CHEST_COST;
        updateTotalAssetsDisplay();
        isGameLocked = true;
        
        const winnerIndex = Math.floor(Math.random() * 3);
        const chests = document.querySelectorAll('.chest');

        chests.forEach((chest, idx) => {
            const resultText = chest.querySelector('.chest-result');
            
            if (idx !== selectedChestIndex) {
                chest.classList.add('disabled');
            }

            if (idx === winnerIndex) {
                chest.classList.add('revealed');
                if (idx === selectedChestIndex) {
                    chest.classList.add('open-money');
                    resultText.innerText = "ğŸ‰ $3000";
                    totalAssets += 3000;
                    setTimeout(() => showMessage("ğŸ‰ æ­å–œç™¼è²¡", "é‹æ°£å¤ªå¥½äº†ï¼<br>ç²å¾—å¤§ç <b>$3000</b>ï¼"), 800);
                } else {
                    chest.classList.add('open-money');
                    resultText.innerText = "$3000";
                }
            } else {
                const smallPrize = Math.random() > 0.5 ? 800 : 0;
                
                if (idx === selectedChestIndex) {
                    if (smallPrize > 0) {
                        chest.classList.add('open-money');
                        resultText.innerText = `ğŸ˜® $${smallPrize}`;
                        totalAssets += smallPrize;
                        setTimeout(() => showMessage("ğŸ˜® é‚„ä¸éŒ¯", `ç²å¾—å°ç <b>$${smallPrize}</b>`), 800);
                    } else {
                        chest.classList.add('open-empty');
                        resultText.innerText = "ğŸ’¨ éŠ˜è¬æƒ é¡§";
                        setTimeout(() => showMessage("ğŸ’¨ å“å‘€...", "è£¡é¢ä»€éº¼éƒ½æ²’æœ‰...<br>åˆ¥æ°£é¤’ï¼Œä¸‹æ¬¡æœƒæ›´å¥½ï¼"), 800);
                    }
                } else {
                    if(smallPrize > 0) {
                        chest.classList.add('open-money');
                        resultText.innerText = `$${smallPrize}`;
                    } else {
                        chest.classList.add('open-empty');
                        resultText.innerText = "éŠ˜è¬æƒ é¡§";
                    }
                    chest.classList.add('revealed'); 
                }
            }
        });

        // ğŸŒŸ æ›´æ–°è³‡ç”¢ä½†ä¸å­˜æª”
        updateTotalAssetsDisplay();
        setTimeout(() => { document.getElementById('replay-btn').classList.remove('hidden'); }, 1500);
    }
</script>
</body>
</html>